<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofia's Private Chess</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .setup-container { width: 100%; max-width: 400px; text-align: center; margin-bottom: 15px; }
        
        /* Sirf Room Code ka input box */
        input#roomCode { 
            width: 80%; 
            padding: 12px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: 2px solid #3498db; 
            background: #2c3e50; 
            color: white; 
            font-size: 18px; 
            text-align: center;
        }

        .btn-group { display: flex; gap: 10px; justify-content: center; }
        button { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; }
        #joinBtn { background: #27ae60; color: white; }
        #botBtn { background: #e67e22; color: white; }
        
        #myBoard { width: 95vw; max-width: 400px; margin-top: 10px; border: 3px solid #333; }
        #status-msg { margin-top: 10px; color: #f1c40f; font-weight: bold; }
    </style>
</head>
<body>

    <div class="setup-container">
        <h2>Enter Match Code</h2>
        <input type="text" id="roomCode" placeholder="Enter Code (e.g. 5566)">
        
        <div class="btn-group">
            <button id="joinBtn" onclick="connectOnline()">Join Online</button>
            <button id="botBtn" onclick="startBot()">Practice vs Bot</button>
        </div>
        <div id="status-msg">Game Status: Not Connected</div>
    </div>

    <div id="myBoard"></div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();
        var board = null;
        var game = new Chess();
        var playerRole = null;
        var currentRoom = null;
        var isBotMode = false;

        function initBoard(orient) {
            board = ChessBoard('myBoard', {
                draggable: true,
                position: 'start',
                orientation: orient || 'white',
                onDragStart: (s, p) => {
                    if (game.game_over()) return false;
                    if (isBotMode && p.search(/^b/) !== -1) return false;
                    if (!isBotMode && ((playerRole === 'w' && p.search(/^b/) !== -1) || (playerRole === 'b' && p.search(/^w/) !== -1))) return false;
                },
                onDrop: (s, t) => {
                    let move = game.move({ from: s, to: t, promotion: 'q' });
                    if (!move) return 'snapback';
                    if (isBotMode) window.setTimeout(makeBotMove, 500);
                    else socket.emit('chessMove', { move, room: currentRoom });
                },
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            });
        }

        // Jab user code daal kar Join dabaye
        function connectOnline() {
            let code = $('#roomCode').val();
            if(!code) return alert("Pehle koi code toh dalo!");
            
            isBotMode = false;
            currentRoom = code;
            socket.emit('joinRoom', { username: "Player", room: code }); // Username ab piche se "Player" hi jayega
            $('#status-msg').text("Joining Room: " + code);
        }

        function startBot() {
            isBotMode = true;
            playerRole = 'w';
            game = new Chess();
            initBoard('white');
            $('#status-msg').text("Mode: Practice with Bot");
        }

        function makeBotMove() {
            let moves = game.moves();
            if (moves.length > 0) {
                game.move(moves[Math.floor(Math.random() * moves.length)]);
                board.position(game.fen());
            }
        }

        socket.on('playerRole', (data) => {
            playerRole = data.role;
            currentRoom = data.room;
            initBoard(playerRole === 'w' ? 'white' : 'black');
            $('#status-msg').text("Game Started! You are " + (playerRole === 'w' ? "White" : "Black"));
        });

        socket.on('moveFromServer', (move) => {
            game.move(move);
            board.position(game.fen());
        });

        initBoard('white');
    </script>
</body>
</html>
