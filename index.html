<!DOCTYPE html>
<html>
<head>
    <title>Online Play - Chess</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; background: #2c3e50; color: white; }
        #myBoard { margin-top: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.5); border: 5px solid #34495e; }
        .controls { margin-top: 20px; text-align: center; }
        .info { margin-top: 10px; font-size: 1.1em; color: #ecf0f1; }
        button { padding: 10px 20px; font-size: 1em; cursor: pointer; background: #27ae60; color: white; border: none; border-radius: 5px; transition: 0.3s; }
        button:hover { background: #2ecc71; }
        #botBtn { background: #e67e22; margin-left: 10px; }
        #botBtn:hover { background: #f39c12; }
    </style>
</head>
<body>
    <h1>Online Play</h1>
    
    <div id="myBoard" style="width: 450px"></div>

    <div class="controls">
        <button onclick="location.reload()">Multiplayer Mode</button>
        <button id="botBtn" onclick="startBotMode()">Practice with Bot</button>
    </div>

    <div class="info">Aapka Rang: <span id="userColor">White</span></div>
    <div class="info">Status: <span id="status">Connecting...</span></div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();
        var board = null;
        var game = new Chess();
        var playerRole = 'w'; 
        var isBotMode = false;

        function onDragStart (source, piece, position, orientation) {
            if (game.game_over()) return false;
            
            // Bot mode mein player hamesha White hoga
            if (isBotMode) {
                if (piece.search(/^b/) !== -1) return false;
            } else {
                if ((playerRole === 'w' && piece.search(/^b/) !== -1) ||
                    (playerRole === 'b' && piece.search(/^w/) !== -1) ||
                    (playerRole === 'viewer')) return false;
            }
        }

        function makeRandomMove () {
            var possibleMoves = game.moves();
            if (possibleMoves.length === 0) return;

            var randomIdx = Math.floor(Math.random() * possibleMoves.length);
            game.move(possibleMoves[randomIdx]);
            board.position(game.fen());
            updateStatus();
        }

        function onDrop (source, target) {
            var move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';

            if (isBotMode) {
                window.setTimeout(makeRandomMove, 500);
            } else {
                socket.emit('chessMove', move);
            }
            updateStatus();
        }

        function startBotMode() {
            isBotMode = true;
            game = new Chess();
            board.start();
            board.orientation('white');
            $('#userColor').html('White (vs Bot)');
            $('#status').html('Practice shuru karein!');
            $('#botBtn').hide();
        }

        function updateStatus () {
            var status = '';
            var moveColor = (game.turn() === 'b') ? 'Black' : 'White';
            if (game.in_checkmate()) status = 'Game Over! ' + moveColor + ' Checkmate.';
            else if (game.in_draw()) status = 'Game Draw!';
            else status = moveColor + ' ki baari hai';
            $('#status').html(status);
        }

        socket.on('playerRole', function(role) {
            if (isBotMode) return;
            playerRole = role;
            $('#userColor').html(role === 'w' ? 'White' : (role === 'b' ? 'Black' : 'Viewer'));
            
            var config = {
                draggable: true,
                position: 'start',
                orientation: (role === 'b') ? 'black' : 'white',
                onDragStart: onDragStart,
                onDrop: onDrop,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            };
            board = ChessBoard('myBoard', config);
            updateStatus();
        });

        socket.on('moveFromServer', function(move) {
            if (isBotMode) return;
            game.move(move);
            board.position(game.fen());
            updateStatus();
        });
    </script>
</body>
</html>