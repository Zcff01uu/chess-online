<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Chess</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
        
        #menu-screen { width: 90%; max-width: 400px; text-align: center; background: #1e1e1e; padding: 25px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); border: 1px solid #333; display: block; }
        h1 { color: #f1c40f; margin-bottom: 25px; text-transform: uppercase; letter-spacing: 1px; }
        input { width: 85%; padding: 15px; margin-bottom: 20px; border-radius: 10px; border: 2px solid #444; background: #252525; color: white; font-size: 18px; text-align: center; outline: none; }
        .btn-stack { display: flex; flex-direction: column; gap: 12px; }
        button { padding: 16px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px; text-transform: uppercase; color: white; transition: 0.2s; }
        
        #createBtn { background: #2980b9; }
        #joinBtn { background: #27ae60; }
        #botBtn { background: #c0392b; }

        #game-screen { display: none; width: 100%; max-width: 450px; text-align: center; }
        #myBoard { width: 100%; border: 5px solid #333; border-radius: 10px; margin: 10px 0; }
        #status-bar { padding: 12px; background: #222; border-radius: 8px; color: #f1c40f; font-weight: bold; border: 1px solid #444; }

        /* EXIT Button hamesha ke liye */
        .main-exit-btn { background: #555; margin-top: 15px; width: 120px; padding: 10px; font-size: 14px; }

        /* Game Over Modal */
        #game-over-modal { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(30, 30, 30, 0.98); padding: 30px; border-radius: 15px; 
            box-shadow: 0 0 30px rgba(0,0,0,1); z-index: 1000; text-align: center; border: 2px solid #f1c40f;
        }
        .play-again-btn { background: #27ae60; width: 200px; }
    </style>
</head>
<body>

    <div id="menu-screen">
        <h1>PLAY ULTIMATE CHESS</h1>
        <input type="text" id="roomCode" placeholder="Enter Code (e.g. 1122)">
        <div class="btn-stack">
            <button id="createBtn" onclick="handleOnline('create')">Create Room</button>
            <button id="joinBtn" onclick="handleOnline('join')">Join Online</button>
            <button id="botBtn" onclick="startBot()">Play vs Powerful Bot</button>
        </div>
    </div>

    <div id="game-screen">
        <div id="status-bar">Status: Waiting...</div>
        <div id="myBoard"></div>
        <button class="main-exit-btn" onclick="location.reload()">EXIT GAME</button>
    </div>

    <div id="game-over-modal">
        <h2 id="winner-text">CHECKMATE!</h2>
        <button class="play-again-btn" onclick="resetGame()">PLAY AGAIN</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        var board = null;
        var game = new Chess();
        var socket = io();
        var isBotMode = false;
        var playerRole = 'w';
        var currentRoom = null;

        function showGameScreen() {
            $('#menu-screen').hide();
            $('#game-screen').show();
            $('#game-over-modal').hide();
        }

        function resetGame() {
            game.reset();
            board.start();
            $('#game-over-modal').fadeOut();
            $('#status-bar').text(isBotMode ? "vs Powerful Bot" : "Game Restarted!");
        }

        function triggerCheckmate(winner) {
            confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 } });
            $('#status-bar').text("GAME OVER!");
            $('#winner-text').text(winner + " WINS!");
            setTimeout(() => { $('#game-over-modal').fadeIn(); }, 1000);
        }

        function makeBotMove() {
            if (game.game_over()) return;
            let moves = game.moves();
            let move = moves.find(m => m.includes('#')) || moves.find(m => m.includes('x')) || moves[Math.floor(Math.random() * moves.length)];
            game.move(move);
            board.position(game.fen());
            checkGameStatus();
        }

        function checkGameStatus() {
            if (game.in_checkmate()) {
                let winner = game.turn() === 'w' ? 'Black' : 'White';
                triggerCheckmate(winner);
            } else if (game.in_draw()) {
                $('#winner-text').text("IT'S A DRAW!");
                $('#game-over-modal').fadeIn();
            }
        }

        function onDrop(source, target) {
            let move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            checkGameStatus();
            if (isBotMode && !game.game_over()) {
                $('#status-bar').text("Bot is thinking...");
                window.setTimeout(makeBotMove, 600);
            } else if (!isBotMode) {
                socket.emit('chessMove', { move: move, room: currentRoom });
            }
        }

        function initBoard(orient) {
            setTimeout(() => {
                board = ChessBoard('myBoard', {
                    draggable: true,
                    position: 'start',
                    orientation: orient || 'white',
                    onDragStart: (s, p) => {
                        if (game.game_over()) return false;
                        if (isBotMode && p.startsWith('b')) return false;
                        if (!isBotMode && ((playerRole === 'w' && p.startsWith('b')) || (playerRole === 'b' && p.startsWith('w')))) return false;
                    },
                    onDrop: onDrop,
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
                });
            }, 150);
        }

        function startBot() {
            isBotMode = true;
            showGameScreen();
            initBoard('white');
            $('#status-bar').text("vs Powerful Bot");
        }

        function handleOnline(type) {
            let code = $('#roomCode').val();
            if(!code) return alert("Code dalo Sofia!");
            isBotMode = false;
            currentRoom = code;
            socket.emit('joinRoom', { room: code });
            showGameScreen();
        }

        socket.on('playerRole', (data) => {
            playerRole = data.role;
            currentRoom = data.room;
            initBoard(playerRole === 'w' ? 'white' : 'black');
        });

        socket.on('moveFromServer', (move) => {
            game.move(move);
            board.position(game.fen());
            checkGameStatus();
        });
    </script>
</body>
</html>
